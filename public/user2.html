<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Karaoke Web ğŸ§ Usuario 2</title>
  <link rel="stylesheet" href="css/style.css" />
</head>

<body>
  <!-- ğŸ”¹ Encabezado -->
  <header>
    <h1>ğŸ§ Usuario 2</h1>
    <button id="btn-reset-rol" class="btn-secondary">Cambiar rol</button>
  </header>

  <!-- ğŸ”¹ Contenido principal -->
  <main>
    <!-- ğŸµ Controles -->
    <section class="player">
      <select id="selector-cancion"></select>
      <button id="btn-cargar" class="btn-primary">Cargar</button>
      <button id="btn-mic" class="btn-mic">ğŸ™ï¸ MicrÃ³fono</button>
      <button id="btn-play" class="btn-icon">â–¶ï¸ Play</button>
      <button id="btn-pause" class="btn-icon">â¸ï¸ Pausa</button>
    </section>

    <!-- ğŸ¯ Afinador -->
    <section class="afinador">
      <div id="afinador-container">
        <canvas id="canvas-afinacion" width="400" height="250"></canvas>
        <div class="etiquetas">
          <span id="label-actual">â€“ Hz</span>
          <span id="label-estado" class="warn">Conectando...</span>
        </div>
      </div>
    </section>

    <!-- ğŸµ Audio -->
    <audio id="audio" controls style="width:100%"></audio>

    <!-- ğŸ¶ Letra -->
    <section class="letra">
      <div id="letra-container">
        <p id="letra-actual">ğŸ¶ Esperando canciÃ³n...</p>
      </div>
    </section>
  </main>

  <!-- ğŸ”¹ Scripts principales -->
  <script src="/socket.io/socket.io.js"></script>
  <script type="module">
    import { KaraokeApp } from "./js/karaoke.js";
    import { getUserName, selectSong } from "./js/socketClient.js";

    // Inicializar la app del karaoke
    const app = new KaraokeApp({
      audioId: "audio",
      btnMicId: "btn-mic",
      canvasId: "canvas-afinacion",
      labelHzId: "label-actual",
      labelEstadoId: "label-estado",
      lyricsId: "letra-actual"
    });
    app.init();

    // === Elementos principales ===
    const selector = document.getElementById("selector-cancion");
    const btnCargar = document.getElementById("btn-cargar");
    const audio = document.getElementById("audio");
    const btnPlay = document.getElementById("btn-play");
    const btnPause = document.getElementById("btn-pause");

    // === Cargar canciones desde el servidor ===
    async function cargarCanciones() {
      try {
        const res = await fetch("/api/songs");
        const songs = await res.json();
        selector.innerHTML = songs.map(s => `<option value="${s}">${s}</option>`).join("");
      } catch (e) {
        console.error("Error al obtener canciones:", e);
      }
    }
    cargarCanciones();

    // === Enviar selecciÃ³n de canciÃ³n al host ===
    btnCargar.onclick = () => {
      const song = selector.value;
      if (!song) return alert("Selecciona una canciÃ³n primero.");
      selectSong(song);
    };

    // === Reaccionar cuando el host selecciona canciÃ³n ===
    window.socket.on("songSelected", (song) => {
      const ruta = `/uploads/${song}`;
      audio.src = ruta;
      audio.load();
      audio.oncanplay = () => {
        audio.play();
        app.setSong(ruta); // carga la referencia del artista
      };
    });

    // === Sincronizar controles de mÃºsica ===
    btnPlay.onclick = () => {
      if (!audio.src) return;
      audio.play();
      window.socket.emit("musicControl", { action: "play", from: getUserName() });
    };

    btnPause.onclick = () => {
      if (!audio.src) return;
      audio.pause();
      window.socket.emit("musicControl", { action: "pause", from: getUserName() });
    };

    // === Reaccionar a eventos remotos (control del host) ===
    window.socket.on("musicControl", (data) => {
      if (data.from === getUserName()) return;
      if (data.action === "play") audio.play();
      if (data.action === "pause") audio.pause();
    });

    // === Comprobar rol guardado ===
    const role = localStorage.getItem("karaokeRole");
    if (role !== "user2") {
      // Si no es user2, volver al index
      window.location.href = "index.html";
    }
  </script>

  <!-- ğŸ”¹ Reiniciar selecciÃ³n de rol -->
  <script>
    document.getElementById("btn-reset-rol").addEventListener("click", () => {
      localStorage.removeItem("karaokeRole");
      alert("Rol eliminado. Se mostrarÃ¡ el selector de nuevo al recargar.");
      window.location.href = "index.html";
    });
  </script>
</body>
</html>
